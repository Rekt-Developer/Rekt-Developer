name: Profile Automation

on:
  schedule:
    - cron: "0 */12 * * *"  # Every 12 hours
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  update-profile:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      NODE_VERSION: '16'
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      USERNAME: ${{ github.repository_owner }}
      EMAIL: "github-actions[bot]@users.noreply.github.com"
      NAME: "github-actions[bot]"

    steps:
      # Step 1: Checkout Code
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Step 2: Set up Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      # Step 3: Create Necessary Directories
      - name: Create Required Directories
        run: mkdir -p dist profile-3d-contrib assets

      # Step 4: Generate Snake Animation
      - name: Generate Snake Animation
        uses: Platane/snk@v3
        with:
          github_user_name: ${{ env.USERNAME }}
          outputs: |
            dist/github-snake.svg
            dist/github-snake-dark.svg?palette=github-dark
            dist/ocean.gif?color_snake=orange&color_dots=#bfd6f6,#8dbdff,#64a1f4,#4b91f1,#3c7dd9
            dist/ocean-dark.gif?color_snake=orange&color_dots=#161b22,#0d1117,#161b22,#0d1117,#161b22
        env:
          GITHUB_TOKEN: ${{ env.GITHUB_TOKEN }}

      # Step 5: Generate 3D Contribution Calendar
      - name: Generate 3D Contribution Calendar
        uses: yoshi389111/github-profile-3d-contrib@0.7.1
        env:
          GITHUB_TOKEN: ${{ env.GITHUB_TOKEN }}
          USERNAME: ${{ env.USERNAME }}

      # Step 6: Create Dynamic Banners
      - name: Generate Dynamic Banners
        run: |
          # Light Theme Banner
          curl -o assets/banner-light.gif \
          "https://readme-typing-svg.demolab.com?font=Fira+Code&duration=3000&pause=1000&color=38BDAE&center=true&vCenter=true&width=435&lines=Welcome+to+my+Profile!;Full+Stack+Developer;Open+Source+Enthusiast;Tech+Explorer"
          
          # Dark Theme Banner
          curl -o assets/banner-dark.gif \
          "https://readme-typing-svg.demolab.com?font=Fira+Code&duration=3000&pause=1000&color=38BDAE&center=true&vCenter=true&width=435&lines=Welcome+to+my+Profile!;Full+Stack+Developer;Open+Source+Enthusiast;Tech+Explorer&bg=0D1117"

      # Step 7: Generate Metrics SVG
      - name: Generate Metrics SVG
        run: |
          curl -o dist/metrics.svg \
          "https://github-readme-stats.vercel.app/api?username=${{ env.USERNAME }}&show_icons=true&theme=tokyonight&hide_border=true&bg_color=0D1117&ring_color=38BDAE"

      # Step 8: Generate Activity Graph SVG
      - name: Generate Activity Graph
        run: |
          curl -o dist/activity.svg \
          "https://github-readme-activity-graph.vercel.app/graph?username=${{ env.USERNAME }}&theme=tokyo-night&hide_border=true&bg_color=0D1117"

      # Step 9: Update Profile Content in README
      - name: Update Profile Content
        run: |
          # Retrieve repository stats
          REPOS=$(curl -s -H "Authorization: token ${{ env.GITHUB_TOKEN }}" \
            "https://api.github.com/users/${{ env.USERNAME }}/repos?per_page=100")
          
          # Calculate metrics
          STARS=$(echo $REPOS | jq -r 'map(.stargazers_count) | add')
          FORKS=$(echo $REPOS | jq -r 'map(.forks_count) | add')
          CONTRIBUTIONS=$(curl -s -H "Authorization: token ${{ env.GITHUB_TOKEN }}" \
            "https://api.github.com/search/commits?q=author:${{ env.USERNAME }}" \
            | jq -r '.total_count')
          
          # Update README with dynamic values
          sed -i "s/\"stars\": [0-9]*/\"stars\": $STARS/" README.md
          sed -i "s/\"forks\": [0-9]*/\"forks\": $FORKS/" README.md
          sed -i "s/\"contributions\": [0-9]*/\"contributions\": $CONTRIBUTIONS/" README.md
          
          # Update the last updated timestamp
          sed -i "s/Last Updated: .*/Last Updated: $(date '+%Y-%m-%d %H:%M:%S UTC')/" README.md

      # Step 10: Optimize Images
      - name: Optimize Images
        run: |
          sudo apt-get update && sudo apt-get install -y optipng
          find dist assets -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" \) -exec optipng -o5 {} \;

      # Step 11: Commit Changes
      - name: Commit Changes
        run: |
          git config --local user.email "${{ env.EMAIL }}"
          git config --local user.name "${{ env.NAME }}"
          git add -A
          git commit -m "chore: update profile content [skip ci]" || exit 0
          git push

      # Step 12: Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ env.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: output
          force_orphan: true
          user_name: ${{ env.NAME }}
          user_email: ${{ env.EMAIL }}
          commit_message: 'chore: update profile assets'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
